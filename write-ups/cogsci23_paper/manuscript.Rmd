---
title: "TODO"
bibliography: [ aaflowers.bib]
csl: apa6.csl
document-params: "10pt, letterpaper"

author-information: > 
    \author{{\large \bf Morton Ann Gernsbacher (MAG@Macc.Wisc.Edu)} \\ Department of Psychology, 1202 W. Johnson Street \\ Madison, WI 53706 USA
    \AND {\large \bf Sharon J.~Derry (SDJ@Macc.Wisc.Edu)} \\ Department of Educational Psychology, 1025 W. Johnson Street \\ Madison, WI 53706 USA}

abstract: >
    TODO
    
keywords: >
    Add your choice of indexing terms or keywords; kindly use a semi-colon; between each term.
    
output: cogsci2016::cogsci_paper
#final-submission: \cogscifinalcopy
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=3, fig.height=3, fig.crop = F, 
                      fig.pos = "tb", fig.path='figs/',
                      echo=F, warning=F, cache=F, 
                      message=F, sanitize = T)
library(here)
library(tidyverse)
#library(rstanarm)
#library(rstan)
library(tidybayes)
library(viridis)
library(cowplot)
library(lsa)
#rstan_options(auto_write = TRUE)
#options(mc.cores = parallel::detectCores())
#for plotting
theme_set(theme_bw())

#Data import constants
date_start=lubridate::ymd('2021-07-19')
fig_path=here("write-ups/cogsci23_paper/figs")
read_data_path <- "data/processed_data/joined_data/"
annotation_path <- "data/annotations"
model_path <- "code/models"

stats <- function(model, row){
  str_c(model[row,1],": Est=", model[row,2], ", CrI=", model[row,3])
}

stats_text  <- function(model, row){
  str_c( model[row,2], " CrI=", model[row,3],"")
}
```

```{r}
d.games <- read_csv(here(read_data_path, "games.csv")) |> 
                        mutate(conditionName = condition, 
         condition = case_when(conditionName == "coopMulti" ~ "Shared Utilities",
                               conditionName == "competCartel" ~ "Individual Utilities",
                               conditionName == "coopCartel" ~ "Old Cooperative",
                               TRUE ~ conditionName)) |> 
  filter(chatEnabled) |> 
  select(gameId,conditionName, condition)

n_players = 3
n_rounds = 24

d.rounds <- read_csv(here(read_data_path,"rounds.csv"))
d.players <- read_csv(here(read_data_path, "players.csv")) |> select(playerId,name)
game_completion <- d.rounds %>% 
  group_by(gameId) %>% 
  tally() %>% 
  mutate(game_complete = n==n_players*n_rounds) %>%
  select(gameId, game_complete)

d.games.final <- d.games %>% 
  left_join(game_completion) %>% 
  replace_na(list(game_complete = FALSE, n_trials = 0)) |> 
  filter(game_complete)

d.rounds.final <-  d.rounds %>% 
  inner_join(d.games.final) %>% 
  filter(conditionName != "coopCartel",
         game_complete) |> 
  left_join(d.players) |> 
  #left_join(d.games) |> 
  select(gameId,trialNum, name, condition)


annotated <-  read_csv(here(annotation_path, "flowers_annotations.csv")) |> 
  filter(!is.na(normalized_span)) |> 
  inner_join(d.games.final) |> 
  mutate(numchar=str_length(span),
         numword=ifelse(numchar==0,0,str_count(span, "\\W+") + 1)) |> 
  mutate(flower=str_c(referent,color),
         player=str_c(gameId, name)) |> 
  select(gameId, player,name, flower, trialNum, pResp, normalized_span,color,numchar, numword, condition)


```

# introduction

Successful communication is grounded in a shared understanding of what utterances mean in the context they are produced in. In many cases conventional word meanings are enough, but there are also contexts where objects to be referred to are not easy to distinguish. In these situations, establishing reference is more difficult, but no less important. 

The formation of these ad-hoc referring expressions has been studied extensively in the context of dyadic reference games [@clarkReferringCollaborativeProcess1986, ADD MORE CITES]. In these, two participants see a set of images (often abstract shapes) and one person is tasked with identifying an image so the other person can pick it out. People can be very successful at this task, achieving high levels of matches. Over repeated reference to the same images, pairs develop shorthand names for the images, leading to shorter descriptions in later repetitions. These nicknames conventionalize with a pair, as they tend to stick to the same description, but are ideosyncratic and differ between pairs. 

This has been a well-studied microcosm for understanding reference which has proven useful for testing theories about how referring expressions originate, how expressions are designed, etc [TODO]. The implicit theoretical claim is that these phenomena hold whenever people interact repeatedly in ways that require reference to some objects that do not have pre-conventionalized names that are adequate to distinguish them in context.

However, there are some ways in which this microcosm is not representative of typical language use. For one, in everyday communication, establishing reference rarely happens in isolation but is usually a subgoal in a larger conversational goal. The overall goal might be cooperative, such as in asking for a piece of kitchen equipment while cooking together, but it can also be adversarial, such as in a negotiation where the assets to be divied up must be referenced. In the reference game context, the goal is always cooperative, to match the images or get them in the same order. 

The variation in goals can also lead to choices about when and what to refer to and how precise to be, depending on the costs of mistaken reference. 

Do the results of dyadic reference games extend to more complex communicative interactions where goals are more complex and may not be aligned?  

[possible worth acknowledging somewhere that sometimes esp. in legal things and philosophy, fighting over names is the argument, and we're going to ignore that]

```{r interface, fig.env = "figure*", fig.pos = "t!", fig.width=6, fig.height=2, fig.align = "center", set.cap.width=T, num.cols.cap=2, fig.cap = "Player interface. Panel A shows the selection phase, where each participant sees 6 flowers, 4 with value bars. Panel B shows the feedback stage, after all players have selected. When multiple players select the same flower, they recieve a lower value rather than what is shown.  \\label{interface}", cache=FALSE}

selection <- png::readPNG(here(fig_path, "selection.png"))

feedback <- png::readPNG(here(fig_path, "feedback.png"))

a <- ggdraw() + draw_image(selection)
b <- ggdraw()+draw_image(feedback)

plot_grid(a,b, labels="AUTO")
```

[needs transition, but not sure how]

@mankewitz2021 tried to bridge the gap between datasets of negotiation over easily nameable objects, and the reference game literature where there is reference (but no negotiation) over hard to name objects. They created a 3 person game where players each select what flowers to grow from a set of 6 flowers with variable and partially hidden value. Players got the value of the flower only if they were the only one to select it, which incentivized coordination and negotiation between players. However, all the flowers shown were the same color, so they were not easily nameable, and the flowers repeated, leading to opportunities for ad-hoc conventionalization. This game structure encouraged players to describe flowers while never explicitly saying that a player should refer to any specific flower. They also had two conditions, one where players within a group won points together (and thus had fully aligned incentives) and another where they won points as individuals (and didn't). @mankewitz2021 found a slight decrease in language over the course of hte game, possibly consistent with reduced referring expressions, but also consistent with developing a negotiation pattern. 


Here we extracted the referring expressions from the chat logs of @mankewitz to look for reduction to partner-specific terms. We explored whether the phenomena found in classic dyadic iterated reference games extended to this more naturalistic domain, and whether they differed across the individual and shared incentive conditions. The key questions we addressed are:

1. Do the referring expressions get shorter over time? 

2. Do referring expressions for the same image converge within a group?

3. Do referring expressions for different images diverge within a group?

4. Do referring expressions for the same image diverge between groups? 

[TODO fix list of key points to match results.]


# Methods

This paper presents a reanalysis of data from @mankewitz2021. We describe both the original data collection and the additional data processing done for reanalysis. 

## Data Acquisition
As described in @mankewitz2021, participants played a real-time coordination game in groups of three, implemented using Empirica [@almaatouqEmpiricaVirtualLab2020]. On each trial, each group saw a set of 6 flower images (Figure \ref{interface}A) . Each participant saw the values for four of the flowers (represented as a colored bar), such that each flower's value was hidden from one participant. Players could coordinate and discuss using a chat box before each selected a flower. If one player selected a flower, it was worth the shown reward; if multiple players collided and selected the same flower, they each got a lower reward instead (Figure \ref{interface}B). This incentivized participants to communicate about the flowers in order to coordinate on selecting differenct flowers. The rewards earned over the course of game translated in a monetary bonus for the participants at the end of the game. 

In *individual utility* games, each player earned points for the flowers they selected; in the *shared utility* games, the points earned were averaged together, and all players in a game got the same reward. This made for slightly different incentives; in an individual game, players wanted to maximize the rewards of flowers they selected, and only cared about avoiding collisions with other players' selections; in a shared game, players wanted their teammates to select different high reward flowers, and were indifferent on who selected the highest one. 

Each game was assigned a color of flower (white, red, yellow, purple) and the flower images were drawn from a set of 12 for that color, so players saw the same flowers repeatedly across the game, in different combinations. Each game consisted of 24 trials. The use of different flowers of the same color created situations where players did not have established names for the flowers in context and needed to develop shared referring expressions to clearly communicate with their partners. 

After the game, players were asked how they would describe each of the images they had played with to their teammates. They were also asked how they would describe each of 4 images from a different color set than the one they had used. 

## Exclusions 
Following @mankewitz2021 we only included games where players finished all 24 trials in the game. We only included games where participants had access tt the chat box (@mankewitz2021 also had a no-chat baseline condition). This left us with `r d.games.final |> filter(condition=="Individual Utilities") |> nrow()` games in the individual utilities condition and `r d.games.final |> filter(condition=="Shared Utilities") |> nrow()` in the shared utilities Condition. 

## Textual annotations

```{r, include=F}
vb <- read_csv(here(annotation_path, "vb_agreement.csv")) %>% rename(vb_span=span,vb_referent=referent) %>% 
  mutate(vb_span=ifelse(str_starts(vb_span, "the "), str_sub(vb_span, 5, -1), vb_span)) %>% 
  mutate(row=row_number())
bl <- read_csv(here(annotation_path, "bl_agreement.csv")) %>% rename(bl_span=span,bl_referent=referent) %>% 
  mutate(bl_span=str_sub(bl_span, 2,-2)) %>% #remove quote marks
  mutate(row=row_number())

both <- vb %>% full_join(bl) %>% 
  mutate(same_span=ifelse(vb_span==bl_span, 1,0),
         same_ref=ifelse(vb_referent==bl_referent, 1,0)) %>% 
  select(text,vb_span, bl_span, vb_referent,bl_referent, same_span, same_ref) |> 
  filter(!(is.na(vb_span)&is.na(bl_span)))

raw_rows <- vb |> select(text) |> nrow()
vb |> select(gameId) |> unique() |> nrow()


agree_span <- both %>% group_by(same_span) |> tally() |> filter(same_span==1) |> pluck(2)


count <- both %>% filter(!is.na(bl_referent))

agree_target <- count |> group_by(same_ref) %>% tally() |> filter(same_ref==1) |> pluck(2)

```

We annotated the chat transcripts to extract all referring expressions and identify which flower image each expression referred to. We also spellchecked and corrected the referring expressions. Annotations were done primarily by the first author, with some done by a research assistant. 

Two games consisting of `r raw_rows` utterances were annotated by both annotators.  `r nrow(both)` utterances were identified as containing reference expressions by at least one annotator; of these annotators agreed on the exact reference expression for `r agree_span` (`r round(agree_span/nrow(both)*100)`%) of the cases. The second annotator coded the target of the referring expression for `r nrow(count)` of the utterances. Of these, the two annotators agreed on the target in `r agree_target` (`r round(agree_target/nrow(count)*100)`%) of cases. We take this high level of interannotator agreement as an indication that the reference spans and targets were identified in a reliable way. 

We extracted a total of `r annotated |> filter(numword>0) |>  tally()` referring expressions. 
```{r wordcount, fig.env = "figure*", fig.pos = "h", fig.align = "center", set.cap.width=T, num.cols.cap=2, fig.cap = "Amount of words produced in referring expressions across trial in games in both conditions. A: Total words of referring language per game per trial. B: Words in each reference expression by trial. C: Total number of reference expressions per game per trial. \\label{wordcount}", fig.height=2, fig.width=7}

possible <- d.rounds.final |> select(-name) |> unique()

sum_words <- annotated %>% filter(numword>0) |>  group_by(trialNum, gameId,condition) %>% summarize(sum_char=sum(numchar),
                                           sum_word=sum(numword)) |> full_join(possible) |> 
  mutate(sum_char=ifelse(is.na(sum_char),0,sum_char),
         sum_word=ifelse(is.na(sum_word),0,sum_word))
  
     total <-  ggplot(sum_words,aes(x=trialNum+1,y=sum_word, color=condition))+
   # geom_smooth(method="lm", se=T)+
            geom_smooth(method="lm", formula=y~poly(x,2), se=T)+

        geom_jitter(alpha=.05, width=.2, height=.5)+
        labs(y="Words in reference \n expressions per trial", x="Trial Number", color="")+
        theme(legend.position="bottom", legend.title=element_blank(), axis.title = element_text(size=8))+
        scale_x_continuous(limits=c(1,24), breaks=c(6,12,18,24))+
        scale_color_brewer(palette="Dark2")+
        guides(color = guide_legend(override.aes = list(linetype = NA, alpha=1, fill=NA, size=5) ) )


    legend <- get_legend(total)
    
    all_words <- total+theme(legend.position = "none") 
      
        words <- ggplot(annotated |> filter(numword>0),aes(x=trialNum,y=numword, color=condition))+geom_jitter(alpha=.01)+ geom_smooth()+
          labs(y="Words per reference", x="Trial Number")+
        theme(legend.position="none", legend.title=element_blank(), axis.title = element_text(size=8))+
        scale_x_continuous(limits=c(1,24), breaks=c(6,12,18,24))+
        scale_color_brewer(palette="Dark2")
        
        utts <- annotated |> filter(numword>0) |>
          group_by(gameId, trialNum, condition) |> tally() |> full_join(possible) |> 
          mutate(n=ifelse(is.na(n),0,n)) |> 
  ggplot(aes(x=trialNum, y=n, color=condition))+geom_jitter(alpha=.05)+geom_smooth()+
          labs(y="References per trial", x="Trial Number")+
        theme(legend.position="none", legend.title=element_blank(), axis.title = element_text(size=8))+
        scale_x_continuous(limits=c(1,24), breaks=c(6,12,18,24))+
        scale_color_brewer(palette="Dark2")
        
        top <- plot_grid(all_words, words, utts,nrow=1, labels="AUTO")
        plot_grid(top, legend, nrow=2, rel_heights=c(1,.15))

```

## SBERT embeddings

We embedded each of the extracted referring expressions using SBERT [@reimers2019], and used cosine distance between embedding pairs as a measure of similarity between the corresponding referring expressions. 

For the pairwise comparisons of utterances during the game, we took the similarities for utterances that were within 2 trials of each other (ex. an utterance from trial 10 was compared with utterances from trials 8,9,10,11,12). Presentation of flowers was randomized, so different groups saw different flowers combinations on the same number trial. The width of the comparison window was a compromise between having enough pairs of utterances while still being able to treat them as coming from one time point in the game. 

# Results

We address each of the questions of interest listed at the end of the Introduction. 

## Reduction of referring expressions

```{r}
possible <- d.rounds.final |> select(-name) |> unique()

per_game <-  annotated |> group_by(gameId, trialNum, condition) |> select(flower) |> unique() |> tally() |> full_join(possible) |> 
  mutate(n=ifelse(is.na(n),0,n)) 

mean_flowers <- per_game |> group_by(condition) |> summarize(mean=mean(n) |> round(2), sd=sd(n) |> round(2), summ=str_c(mean," (sd: ",sd,")")) |> 
  select(condition, summ)

per_person <- annotated |> group_by(gameId, trialNum, condition, player, name) |> select(flower) |> unique() |> tally() |> full_join(d.rounds.final) |> 
  mutate(n=ifelse(is.na(n),0,n))
mean_person <- per_person |> group_by(condition) |> summarize(mean=mean(n) |> round(2), sd=sd(n) |> round(2), summ=str_c(mean," (sd: ",sd,")")) |> 
  select(condition, summ)
```

```{r,eval=F, include=F}

m1 <- stan_lmer(numword ~ trialNum + condition + (1|gameId)+ (1|player)+(1|flower), data=annotated) |> write_rds(here(model_path,"m1.rds"))
show_summary_rstan(m1) |> write_rds(here(model_path,"word_model.rds"))
```

```{r}

word_count <- read_rds(here(model_path,"word_model.rds"))
```

The amount of referring language decreases over the course of the game, consistent with the dyadic reference game pattern. As shown in Figure \ref{wordcount}A, the number of words of referring language decreases across the game in both Shared and Individual utility conditions. The reduction in referring langauge was driven by shorter referring expressions later in the game (Figure \ref{wordcount}B), while the total number of referring expressions per round remained constant (Figure \ref{wordcount}C). 

TODO include model!

Another coarse metric for how referring expressions are produced is how many different flowers are referred to each round. Each round of the game, there are 6 flowers visible on the screen, and participants want to each pick a different one. In general, each trial contained references to 2 or 3 distinct flowers (Individual Utilities: mean of `r  mean_flowers |> pluck(2,1)`, Shared Utilities: `r mean_flowers |> pluck(2,2)`). Most players referred to one flower each round (Individual Utilities: `r  mean_person |> pluck(2,1)`, Shared Utilities: `r mean_person |> pluck(2,2)`). 

The average pattern is consistent with each person saying what flower they plan on choosing. Some games talked less than this and risked collisions. Other games  talked more as players queried the worths of various flowers or confirmed the plan of who would pick what. 

? should there be a visual of these distributions ? 

## Convergence of referring expressions

TODO resummarize what cosine similarity is 

[formatting comment -- changes in cos sim tend to be small, so estimates and CredInts look kinda silly some of the time -- could leave or increase sigfigs which is also silly]

```{r, include=F,}

 d.raw_chat <- read_csv(here(paste(read_data_path, 
                                   "raw_chat.csv", 
                                   sep="")),
                       col_types = cols()) %>% distinct() |> 
   select(gameId, playerId) |> unique()
 
 d.players <- read_csv(here(paste(read_data_path, "players.csv", sep = "")),
                       col_types = cols()) %>% distinct() |> select(playerId,name) |> inner_join(d.raw_chat)

 sbert_single <- read_csv(here(annotation_path,"pre_sbert.csv"))|> 
    left_join(d.players) |> left_join(d.games.final) |> mutate(seen="game") |> 
   select(playerId, gameId, condition, text=normalized_span,referent, color, trialNum, seen) |> bind_cols(readRDS(here(annotation_path,'post_sbert.RData'))  %>% as_tibble())

sbert_post_test <- read_csv(here(annotation_path,"post_test_pre_sbert.csv")) |> 
  mutate(trialNum=25) |> 
 bind_cols(readRDS(here(annotation_path,'post_sbert_post_test.RData'))  %>% as_tibble()) |> inner_join(d.games) |> 
   select(playerId, gameId, condition, text,referent=num, color, trialNum, seen, starts_with("V"))

sbert_all <- sbert_single |> union(sbert_post_test)
F_mat <- sbert_all %>% select(starts_with("V")) %>% as.matrix() #Features
M_mat <- sbert_all %>% 
  select(-starts_with("V")) %>% 
  mutate(feature_ind=row_number())
```

```{r helpers}
# note: cor expects features to be in columns so we transpose
get_sim_matrix = function(df, F_mat, method = 'cosine') {
  feats = F_mat[df$feature_ind,]
  if(method == 'cor') {
    return(cor(t(feats), method = 'pearson'))
  } else if (method == 'euclidean') {
    return(as.matrix(dist(feats, method = 'euclidean')))
  } else if (method == 'cosine') {
    return(as.matrix(lsa::cosine(t(feats))))
  } else {
    stop(paste0('unknown method', method))
  }
}

# note this does de-duplicated version
flatten_sim_matrix <- function(cormat, ids) {
  ut <- upper.tri(cormat)
  data.frame(
    dim1 = ids[row(cormat)[ut]],
    dim2 = ids[col(cormat)[ut]],
    sim  = as.numeric(cormat[ut])
  ) %>%
    mutate(dim1 = as.character(dim1),
           dim2 = as.character(dim2))
}

make_across_df <- function(M_mat, F_mat, method) {
  M_mat %>%
    do(flatten_sim_matrix(get_sim_matrix(., F_mat, method = method),
                          as.character(.$combinedId)))
}
```


```{r, cache=T}

# by trial
flower_all <- M_mat %>% 
  filter(seen %in% c("game")) |> 
  group_by(color,condition) %>% 
  mutate(combinedId=str_c(referent,"_", trialNum, "_",gameId,"_",playerId)) %>% 
  make_across_df(F_mat, 'cosine') %>% 
  separate(dim1, c("ref1", "trialNum1","game1","player1"), convert=T) |> 
  separate(dim2, c("ref2", "trialNum2", "game2", "player2"), convert=T) |> 
 # rename(referent1=dim1,referent2=dim2) %>% 
  mutate(sim = ifelse(is.nan(sim), NA, sim)) %>%
  #filter(ref1!=ref2) %>% 
  mutate(earlier=ifelse(trialNum1>trialNum2,trialNum2, trialNum1) |> as.numeric(),
         later=ifelse(trialNum1>trialNum2, trialNum1,trialNum2) |> as.numeric()) |> 
  ungroup()
```

```{r during, fig.env = "figure*", fig.pos = "h", fig.align = "center", set.cap.width=T, num.cols.cap=2, fig.cap = "Cosine similarities between SBERT embeddings of utterances produced within 2 trials of each other. Utterances were paired with other utterances from different games; from the same game, but a different utterer speaker; or from the same speaker (vertical panels). Utterances were either in reference to different flowers or both in reference to the same flower (horizontal panels). \\label{during}", fig.height=4, fig.width=10, out.width="100%"}
flower_all|> 
  filter(later-earlier<3) |> 
  mutate(distance=case_when(
    player1==player2 ~ "Same Person",
    game1==game2 ~ "Same Game",
    T ~ "Different Games"),
    same_flower=ifelse(ref1==ref2, "Same Flower", "Different Flowers")
  ) |> 
ggplot( aes(x=later,y=sim,color=condition))+     
  stat_summary(aes(group=str_c(color,condition), color=condition),fun.data = "mean_cl_boot", position = position_dodge(width=.3), alpha=.3, geom="point")+
  geom_smooth(formula=y~poly(x,2))+facet_grid(same_flower~distance)+theme(legend.position="bottom", legend.title=element_blank())+
        scale_x_continuous(limits=c(1,24), breaks=c(6,12,18,24))+
        scale_color_brewer(palette="Dark2")+
  labs(x="Trial Number", y="Cosine Similarity")+
  guides(color = guide_legend(override.aes = list(linetype = NA, alpha=1, fill=NA, size=5) ) )

```

```{r}
wi_g_wi_f <- read_rds(here(model_path,"samegame_sameflower_model.rds"))

wi_g_bet_f <- read_rds(here(model_path,"samegame_diffflower_model.rds"))

bet_g_wi_f <- read_rds(here(model_path,"diffgame_sameflower_model.rds"))
```

Reference games have clear structures of repetition, as each image is usually the target once before any are again, and so it makes sense to treat each block as a time point. Because of the different structure of the game, trials are more continuous with each other.  We smooth the random sampling and sparseness of flowers occuring the same trial by treating descriptions from within two trials as being at a comparable time in the game (so descriptions from round 10 are compared with descriptions from rounds 8, 9, 10, 11, and 12). 

### Within games


One of the key claims is that within a partnership, the referring expressions should converge for the same image, but get more different for different images. Convergence would be increasing similarity (higher cosine similarity in later rounds), divergence would be decreasing similarity in later rounds). 

If the dyadic pattern held, we expected similarity to increase over time for the same image with a group. In a model of similarity of utterances within flower and within group, we found that similarity increased over time (trial: `r stats_text(wi_g_wi_f,6)`, see Figure \ref{during} lower middle and lower right panels). Utterances were more similar if they were produced by the same participant (`r stats_text(wi_g_wi_f,8)`), although this did not interact with trial number (`r stats_text(wi_g_wi_f,7)`). Games in the shared utilities condition may have had higher similarities overall (`r stats_text(wi_g_wi_f,2)`), but this did not interact with trial number (`r stats_text(wi_g_wi_f,3)`) or same participant versus different participant (`r stats_text(wi_g_wi_f,5)`).  

In contrast, we expected descriptions of different flowers to diverge within the same group. In a model of similarity between descriptions of different flowers within a group, similarity decreased  over time (trial: `r stats_text(wi_g_bet_f,6)`, see Figure \ref{during} upper middle and upper right panels). Terms were slightly less similar in Shared Utility groups (`r stats_text(wi_g_bet_f,2)`), but this did not interact with trial (`r stats_text(wi_g_bet_f,3)`). There was not an effect of utterances being produced by the same person (`r stats_text(wi_g_bet_f,8)`), or interactions between who said it and trial number (`r stats_text(wi_g_bet_f,7)`) or condition (`r stats_text(wi_g_bet_f,5)`). 

The main results of convergence of descriptions for the same image and divergence between descriptions of different images matches the reference game phenomena. 

### Between games

In reference games, conventions are partner-specific, so over time, descriptions become more particular to the group.  If that held, we expected, utterances describing the same flower in different groups to have lower similarities later in the game. 

In a model of utterance similarities for the same flower in different games, similiarities decreased slightly over time  (trial: `r stats_text(bet_g_wi_f,4)`, see Figure \ref{during} lower left panel). There was a condition difference with shared utility conditions having more similar descriptions across games (`r stats_text(bet_g_wi_f,2)`); this did not interact with trial (`r stats_text(bet_g_wi_f,3)`). 

TODO: what is our possibly explanation for this?!

This may be a fluke, as there are not a huge number of games in either condition, but if it's robust, it could be that the shared utility framing leads to less idiosyncratic descriptions and instead towards more universal priors. 
TODO this should be hedged *a lot* but we can also cite the study about large groupy things and the crab-like images 

```{r }

# by trial
to_end <- M_mat %>% 
  filter(seen %in% c("game", "own")) |> 
  group_by(gameId,color,condition) %>% 
  mutate(combinedId=str_c(referent,"_", trialNum, "_",seen,"_",playerId)) %>% 
  make_across_df(F_mat, 'cosine') %>% 
  separate(dim1, c("ref1", "trialNum1","seen1","player1"), convert=T) |> 
  separate(dim2, c("ref2", "trialNum2", "seen2", "player2"), convert=T) |> 
 # rename(referent1=dim1,referent2=dim2) %>% 
  mutate(sim = ifelse(is.nan(sim), NA, sim)) %>%
  filter(seen1!=seen2) %>% 
  mutate(earlier=ifelse(trialNum1>trialNum2,trialNum2, trialNum1) |> as.numeric(),
         later=ifelse(trialNum1>trialNum2, trialNum1,trialNum2) |> as.numeric()) |> 
  ungroup()
```

```{r}
in_end <- M_mat %>% 
  filter(seen %in% c("own")) |> 
  group_by(color,condition) %>% 
  mutate(combinedId=str_c(referent, "_",seen,"_", gameId, "_",playerId)) %>% 
  make_across_df(F_mat, 'cosine') %>% 
  separate(dim1, c("ref1", "seen1","game1","player1"), convert=T) |> 
  separate(dim2, c("ref2",  "seen2","game2", "player2"), convert=T) |> 
 # rename(referent1=dim1,referent2=dim2) %>% 
  mutate(sim = ifelse(is.nan(sim), NA, sim)) %>%
  ungroup()
```


```{r toend, fig.env="figure", fig.pos = "t", fig.align = "center", out.width="100%", fig.cap = "Cosine similarities between SBERT embeddings of utterances produced during a game and the post-game descriptions of the flowers. \\label{toend}", fig.height=4, fig.width=6}
to_end|> 
  mutate(distance=case_when(
    player1==player2 ~ "Same Person",
    T ~ "Same Game - Different Person"),
        same_flower=ifelse(ref1==ref2, "Same flower", "Different flower")
) |> 
ggplot( aes(x=earlier,y=sim,color=condition))+     
  stat_summary(aes(group=str_c(color,condition), color=condition),fun.data = "mean_cl_boot", position = position_dodge(width=.3), alpha=.3, geom="point")+
  geom_smooth(formula=y~poly(x,2))+facet_grid(same_flower~distance)+theme(legend.position="bottom", legend.title=element_blank())+
        scale_x_continuous(limits=c(1,24), breaks=c(6,12,18,24))+
        scale_color_brewer(palette="Dark2")+
  guides(color = guide_legend(override.aes = list(linetype = NA, alpha=1, fill=NA, size=5) ) )

```

```{r}
to_e_wi_f <- read_rds(here(model_path,"to_end_sameflower_model.rds"))

to_e_bet_f <- read_rds(here(model_path,"to_end_diffflower_model.rds"))

wi_e <- read_rds(here(model_path, "within_end.rds"))
```

## End expressions

```{r withinend, fig.env="figure", fig.pos = "t", fig.align = "center", out.width="90%", fig.width=4, fig.height=2, fig.cap = "Cosine similarities between flower descriptions provided by participants after the game. Descriptions were more similar to each other if they came from the same group and were of the same flower. \\label{withinend}"}
in_end|> 
  filter(player2!=player1) |> 
  mutate(distance=case_when(
    game1==game2 ~ "Same group",
    T ~ "Different group"),
    same_flower=ifelse(ref1==ref2, "Same flower", "Different flower"))|> 
ggplot( aes(x=str_c(same_flower,"\n", distance),y=sim,color=condition))+
  labs(y="Cosine Similarity", x=NULL)+
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width=.3))+theme(legend.position=c(0.2,.75), legend.title=element_blank(), legend.background=element_blank())+
        scale_color_brewer(palette="Dark2")
```

### game to end
As a complementary way of looking at how referring expressions change over time as conventions are formed, we can take the post-game flower descriptions (each player was asked to provide what they would call each flower to their teammates) as the conventions, and look at how the in-game utterances converge to these conventions. 

Descriptions become more similar to the conventions over time  (trial: `r stats_text(to_e_wi_f,6)`, see Figure \ref{toend} lower panels). Utterances were more similar to the convention given by the same person (versus from a groupmate) (`r stats_text(to_e_wi_f,8)`), although this did not interact with trial number (`r stats_text(to_e_wi_f,7)`). Games in the shared utilities condition had utterances that were more similar to their conventions (`r stats_text(to_e_wi_f,2)`), but this did not interact with trial number (`r stats_text(to_e_wi_f,3)`) and did not significantly interact with same participant versus different participant (`r stats_text(to_e_wi_f,5)`).  

There was not a significant divergence from the conventions for other flowers over time (trial: `r stats_text(to_e_bet_f,6)`, see Figure \ref{toend} lower panels). Terms are overall slightly less similar in Shared Utility groups (`r stats_text(to_e_bet_f,2)`), but this does not interact with trial (`r stats_text(to_e_bet_f,3)`). There is not an effect of being said by the same person (`r stats_text(to_e_bet_f,8)`), or interactions between who said it and trial number (`r stats_text(to_e_bet_f,7)`). Similarity to a different convention was slightly higher if was said by the same person in a Shared Utility group (`r stats_text(to_e_bet_f,5)`). 

### within end
One last way of looking at convention formation is to look at how similar the end descriptions were to those of other players, either groupmates or people in different groups (but playing with the same color palette) for the same or different flowers. We expected that within a group, descriptions for the same flower would be much more similar, while descriptions of different flowers would be more different, compared to cross-group similarities. 

As shown in Figure \ref{withinend}, compared to different flowers described by different games as a baseline, descriptions for the same game are more similar (even for different flowers, `r stats_text(wi_e,8)`), descriptions of the same flower are more similar (even across games, `r stats_text(wi_e,6)`), and there is a large interaction effect, where descriptions of the same flower are very similar among groupmates (`r stats_text(wi_e,7)`). Compared with the individual utility condition, shared utility games had more similar descriptions of the same flower between games (`r stats_text(wi_e,3)`). Other differences between the two conditions were small. 

[probably need to talk about this result]
[this whole section might be more interpretable if I centered Shared/indiv utilities in the model?] 

# Discussion
TODO!

Many of the key reduction findings from tangrams generalize to this situation. Specifically, we see utterance reduction over time and w/i group convergence for each image and divergence between images. This situation is different in that we have different stimuli (more natural) and the set up is collaborative and more free-form in what is talked about. These patterns hold for both the individual and group payoff structures.

One difference we see is that groups don’t diverge (from each other). This may be dependent on stimulus properities (are there universal features of some of the images?) and group dynamics

mention the set of departures this made from classic reference game 

Conclusion: The key reference game findings have some generalizability. Settings like this one may be useful for encouraging discussion of a set of images and setting up partial knowledge situations.



```{r 2-col-image, fig.env = "figure*", fig.pos = "h", fig.width=4, fig.height=2, fig.align = "center", set.cap.width=T, num.cols.cap=2, fig.cap = "This image spans both columns. And the caption text is limited to 0.8 of the width of the document."}
#img <- png::readPNG("figs/walrus.png")
#grid::grid.raster(img)
```


```{r image, fig.env = "figure", fig.pos = "H", fig.align='center', fig.width=2, fig.height=2, set.cap.width=T, num.cols.cap=1, fig.cap = "One column image."}
#img <- png::readPNG("figs/lab_logo_stanford.png")
#grid::grid.raster(img)
```




# Acknowledgements

Place acknowledgments (including funding information) in a section at
the end of the paper.

# References 

```{r}
# References will be generated automatically by Pandoc and included here.
# The following code is some latex to format the bibliography. Do not remove it.
```

\setlength{\parindent}{-0.1in} 
\setlength{\leftskip}{0.125in}
\noindent
