---
title: "linguistic_analysis_C-D.Rmd : Linguistic quantity and complexity"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
library(tidyverse)
library(here)
library("stringr")
library(Hmisc)
library("spacyr")
library(ggrepel)

```

## STEP THREE - Linguistic quantity and complexity

```{r main data, include=TRUE}
d<- read_csv("~/Downloads/raw_chat.csv")
d <- d %>% filter(type=="message")
write_csv(d, "~/Downloads/raw_chat1.csv")
```


```{r main data1, include=TRUE}
data_target = "pilot0"
data_location=paste0("data/",data_target)

d_flowers<- read_csv(here(data_location, "raw_chat1.csv"))%>%
 filter(!is.na(text)) 

```

### 1. Utt Length
```{r utt_length}

d_flowers_utt_length <- d_flowers %>%
  mutate(text = gsub('[[:punct:] ]+',' ',text)) %>%
  mutate(utt_length_words = sapply(strsplit(text, " "), length)) %>% 
  group_by(gameId, blockNum, trialNum, repNum, playerId)  %>%
  summarise(total_num_words = sum(utt_length_words),
            mlu = mean(utt_length_words))


ggplot(d_flowers_utt_length, aes(x=repNum, y=total_num_words, color=as.factor(playerId)))+
  scale_color_brewer(palette="Dark2")+
  facet_grid(cols = vars(blockNum), rows =vars(gameId)) +
  geom_jitter(alpha=.05)+
  geom_smooth(method=glm, formula=y~poly(x,2), alpha=.3)+
  stat_summary(fun.data = "mean_cl_boot")+
  scale_y_continuous(limits = c(0,50))+
  labs(title="Number of words", y="Total number of words", x="Round number", color="playerId")+
  theme(legend.position="bottom") + 
  theme_bw() +
  ggtitle("Number of words per Round")


ggplot(d_flowers_utt_length, aes(x=repNum, y=mlu, color=as.factor(playerId)))+
  scale_color_brewer(palette="Dark2")+
  facet_grid(cols = vars(blockNum), rows =vars(gameId)) +
  geom_jitter(alpha=.05)+
  geom_smooth(method=glm, formula=y~poly(x,2), alpha=.3)+
  stat_summary(fun.data = "mean_cl_boot")+
  scale_y_continuous(limits = c(0,15))+
  labs(title="MLU", y="MLU", x="Round number", color="playerId")+
  theme(legend.position="bottom") + 
  theme_bw()+
  ggtitle("MLU per Round")

```

### 2. Number of turns
```{r number_of_turns}


d_flowers_n_turns <- d_flowers %>%
  group_by(gameId, blockNum, trialNum, repNum, playerId)  %>%
  summarise(n=n())

ggplot(d_flowers_n_turns, aes(x=trialNum, y=n, color=as.factor(playerId)))+
  facet_grid(rows =vars(gameId)) +
  scale_color_brewer(palette="Dark2")+
  geom_jitter(alpha=.05)+
  geom_smooth(method=glm, formula=y~poly(x,2), alpha=.3)+
  stat_summary(fun.data = "mean_cl_boot")+
  labs(title="Number of turns", y="Number of turns", x="Round number", color="playerId")+
  theme(legend.position="bottom") + 
  theme_bw() +
  ggtitle("Number of turns per Round")

```


#second plot
### 2b. Number of turns

```{r number_of_turns2}

d_flowers_n_utt_speaker <- d_flowers %>%
  group_by(playerId, trialNum, gameId, blockNum) %>%
  summarise(n_utt_speaker=n())


ggplot(d_flowers_n_utt_speaker, 
       aes(x=trialNum, y=n_utt_speaker, label=playerId)) + 
  geom_smooth(method = "lm", formula = y~x) + 
  geom_point(alpha=.1) +
  facet_grid(~playerId) +
  xlab("Round number") + 
  ylab("Number of utterances") + 
  theme_bw()

```

### 3. Parts of speech
```{r pos}

text <- d_flowers$text
parsed <- spacy_parse(text,pos=TRUE) %>%
  select(doc_id, pos) %>%
  group_by(doc_id) %>%
  mutate(pos = paste(pos, collapse=",")) %>%
  distinct()
  
d_flowers_pos  <- cbind(d_flowers, parsed) %>%
  separate_rows(pos, convert = TRUE) %>%
  group_by(gameId, blockNum, trialNum, repNum, playerId, pos) %>%
  filter(pos=="NOUN"| pos=="VERB" | pos=="ADJ"| pos=="ADP"| pos=="DET" | pos=="PRON") %>%
  summarise(pos_count=n()) %>%
  left_join(d_flowers_utt_length) %>%
  mutate(prop_pos=pos_count/total_num_words)
        

ggplot(d_flowers_pos, 
       aes(x=trialNum, y=prop_pos, label=playerId)) + 
  geom_smooth(method = "lm", formula = y~x) + 
  geom_point(alpha=.1) +
  facet_wrap(~pos, nrow=1)+
  xlab("Round number") + 
  ylab("Proportion of pos") + 
  theme_bw()

```

### 4. Lexical Diversity (TTR)

```{r ttr}

ttr <- function(text_){
  text_ <- tolower(text_)
  total_words = sapply(strsplit(text_, " "), length)
  no_duplicates = vapply(lapply(strsplit(text_, " "), unique), paste, character(1L), collapse = " ")
  total_unique = str_count(no_duplicates, "\\W+") + 1
  ttr_ = total_unique/total_words
  return(ttr_)
}    

d_flowers_text <- d_flowers %>%
    group_by(gameId, blockNum, trialNum, repNum, playerId) %>%
    mutate(text_block = paste0(text, collapse = " ")) %>%
    select(-c(text)) %>%
    distinct() 


d_flowers_ttr <- d_flowers_text %>%
  mutate(ttr_ = ttr(text_block))

#t<-str_split(text_, " ", 1:6)
#y<- paste(unlist(lapply(t,head,n=5)), collapse=" ")

ggplot(d_flowers_ttr, 
       aes(x=trialNum, y=ttr_, label=playerId)) + 
  geom_smooth(method = "lm", formula = y~x) + 
  geom_point(alpha=.1) +
  facet_grid(rows =vars(gameId)) +
  xlab("Round number") + 
  ylab("Type_token ratio") + 
  theme_bw()+
  ggtitle("TTR per Round")

```

## STEP FOUR - Feedback items and markers

### 1. Distribution of speech across speakers
```{r word_length}

d_flowers_n_utt_speaker <- d_flowers %>%
  group_by(playerId, trialNum, gameId, blockNum) %>%
  summarise(n_utt_speaker=n())

d_flowers_n_utt_game <- d_flowers %>%
  group_by(trialNum, gameId, blockNum) %>%
  summarise(n_utt_game=n())

d_flowers_n_utt_dist <- d_flowers_n_utt_speaker %>%
  left_join(d_flowers_n_utt_game) %>%
  mutate(overall_turns=n_utt_speaker/n_utt_game)

ggplot(d_flowers_n_utt_dist, 
       aes(x=trialNum, y=overall_turns, label=playerId)) + 
  geom_smooth(method = "lm", formula = y~x) + 
  geom_point(alpha=.1) +
  facet_wrap(~playerId)+
  xlab("Round number") + 
  ylab("Proportion of turns") + 
  theme_bw()+
  ggtitle("Proportion of turns per Round")

```


### 2. Turn-eliciting questions

```{r questions}


d_flowers_n_utt_speaker <- d_flowers %>%
  group_by(playerId, trialNum, gameId, blockNum) %>%
  summarise(n_utt_speaker=n())



d_flowers_q <- d_flowers %>% 
 mutate(sentence_type = ifelse(str_detect(text, "\\?"), 
                             "question",
                             "other")) %>%
 group_by(playerId, trialNum, gameId, blockNum, sentence_type) %>%
 summarise(n_sentence_Type=n()) %>%
 filter(sentence_type=="question") %>%
 left_join(d_flowers_n_utt_speaker) %>%
 mutate(prop_questions = n_sentence_Type/n_utt_speaker )  


ggplot(d_flowers_q, 
       aes(x=trialNum, y=prop_questions, label=playerId)) + 
  geom_smooth(method = "lm", formula = y~x) + 
  facet_wrap(~ playerId) +
  geom_point(alpha=.1) +
  xlab("Round number") + 
  ylab("Proportion of questions") + 
  theme_bw()+
  ggtitle("Proportion of questions per Round")
  
```

### 1. Distribution of speech across speakers
```{r feedback}

###politeness markers

###backchanneling: (https://www.reading.ac.uk/AcaDepts/ll/app_ling/internal/Cutrone_vol_2.pdf) 

backchanneling<- c("mm", "okay", "uh-huh", "ok", "mm-hm", "uh", "um", "agree", "uhuh", "mmm", "wow", "great", "mm", "hm",  "ummm", "hmmmm", "huh", "un", "um", "ohh", "ooo", "see", "oooo", "ununun", "oh", "ah", "true", "agree", "right", "yeah", "good", "really")

###hedges: (https://www.researchgate.net/publication/280125979_Linguistic_Markers_and_Stylistic_Attributes_of_Hedging_in_English_Academic_Papers_Written_by_Native_and_Non-Native_Speakers_of_English/figures) 

hedging <- c("may", "perhaps", "might", "possible", "likely", "possibly", "maybe", "probable", "appear", "seem", "suggest", "sometimes", "seemingly", "apparently", "often", "could", "usually", "likely", "tend", "sometimes", "probably", "primarily", "tendency", "largely")   


d_flowers_feedback <- d_flowers %>%
  group_by(playerId, trialNum, gameId, blockNum) %>%
  mutate(text = gsub('[[:punct:] ]+',' ',text)) %>%
  mutate(text = strsplit(text, " ")) %>%
  rowwise() %>%
  mutate(backchannel=list(intersect(backchanneling, text))) %>%
  mutate(backchannel_length=length(backchannel))%>%
  mutate(hedge=list(intersect(hedging, text))) %>%
  mutate(hedge_length=length(hedge))

ggplot(d_flowers_feedback, aes(y=trialNum , x=backchannel_length, label=playerId)) +
  facet_wrap(~ playerId) +
  geom_bar(stat="identity")

ggplot(d_flowers_feedback, aes(y=trialNum , x=hedge_length, label=playerId)) +
  facet_wrap(~ playerId) +
  geom_bar(stat="identity")

ggplot(d_flowers_feedback, aes(y=trialNum , x=backchannel_length, label=playerId)) +
  geom_point(alpha = .5)+
  geom_smooth() +
  geom_text_repel(aes(label=ifelse(backchannel=="character(0)",  "", backchannel), max.overlaps = 20))+
  xlim(c(1,5))+
  theme_bw()

ggplot(d_flowers_feedback, aes(y=trialNum , x=hedge_length, label=playerId)) +
  geom_point(alpha = .5)+
  geom_smooth() +
  geom_text_repel(aes(label=ifelse(hedge=="character(0)", "", hedge), max.overlaps = 20))+
  xlim(c(1,5))+
  theme_bw()
  
```




```{r minimum_edit_distance, include=TRUE}

```
